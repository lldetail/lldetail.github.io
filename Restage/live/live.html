<html>
	<head>
		<title>ライブ</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="/cursor/style.css">
		<link rel="stylesheet" type="text/css" href="../restage-font.css">
		<style>
			/* mode */
			#flashlight {
				z-index: 1900;
			}
			#hidden {
				z-index: 1899;
			}
		
		
		
			* {
				font-family: restage !important;
				box-sizing: border-box;
			}
			.grayscale {
				-webkit-filter: grayscale(100%);
				filter: grayscale(100%);
			}
			body {
				margin: 0px;
			}
			h3 {
				background-color: gray;
				color: white;
				border: 1px solid black;
			}
			img.bg {
				position: fixed;
				z-index: 0;
			}
			canvas.bg {
				position: fixed;
				z-index: 3000;
			}
			iframe, video {
				position: fixed;
				z-index: 1000;
			}
			.fullscreen {
				position: fixed;		
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
			}
			textarea{
				width: 100%;
			}
			.protect {
				z-index: 2000;
			}
			.hidden {
				display: none;
			}
			#pause {
				position: fixed;
				z-index: 3500;
			}
			.start, .pause, .vend, .empty {
				z-index: 4000;
				background-color: gray;
				opacity: 0.8;
				color: white;
				text-align: center;
				overflow-y: scroll;
			}
			.empty {
				text-align: left;
				padding: 8px;
			}
			.empty div {
				padding: 8px;
			}
			.options {
				box-sizing: content-box;
				position: fixed;
				right: 0;
				bottom: 0;
				font-size: 3vh;
				line-height: 1;
			}
			.modselect {
				box-sizing: content-box;
				position: fixed;
				left: 0;
				bottom: 0;
				font-size: 3vh;
				line-height: 1;
			}
			.unselected {
				border: 2px solid white;
			}
			.selected {
				border: 2px solid lime;
			}
			#b1, #b2, #b3, #b4, #b5, #b6, #b7 {
				width: 32px;
			}
			#r1, #r2, #r3, #r4, #r5, #r6, #r7 {
				display: inline-block;
				color: -internal-light-dark-color(black, white);
				font: 400 13.3333px Arial;
				padding: 2px 1px;
				border: 1px solid gray;
				width: 32px;
				height: 32px;
			}
			@media only screen and (min-aspect-ratio: 3 / 2) { /* wide */	
				#pause {
					width: 9.75vh;
					top: 2.7vh;
					left: calc(50vw + 64vh);
				}
				.options, .modselect {
					font-size: 3vh;
				}		
				.options img {
					width: 45vh;
				}
				.modselect img {
					width: 15vh;
				}
				.start, .pause {
					font-size: 25vh;
					line-height: 100vh;
				}
				.bg {
					top: -61.5vh;
					height: 194.8vh;
					left: 50%;
					transform: translateX(-50%);
				}
				.r4_3 {
					width: 150vh;
					height: calc(450vh / 4);
					left: calc(50vw - 75vh);
					top: calc(50vh - 450vh / 8);
				}			
				.r16_9 {
					height: 100vh;
					width: calc(1600vh / 9);
					top: 0;
					left: calc(50vw - 800vh / 9);
				}					
			}
			
			@media only screen and (max-aspect-ratio: 3 / 2) { /* tall */	
				#pause {
					width: 6.5vw;
					right: 0.8vw;
					top: calc(50vh - 31vw);
				}
				.options, .modselect {
					font-size: 2vw;
				}		
				.options img {
					width: 30vw;
				}
				.modselect img {
					width: 10vw;
				}
				.start, .pause {
					font-size: 16.67vw;
					line-height: 100vh;
				}
				.bg {
					width: 231.5vw;
					left: 50vw;
					top: 50vh;
					transform: translateX(-50%) translateY(-57.1%);
				}
				.r4_3 {
					width: 100vw;
					height: 75vw;
					left: 0;
					top: calc(50vh - 75vw / 2);
				}		
				.r16_9 {
					width: calc(3200vw / 27);
					height: calc(200vw / 3);
					top: calc(50vh - 100vw / 3);
					left: calc(50vw - 1600vw / 27);
				}			
			}
		</style>
		<script src="https://www.youtube.com/iframe_api">
		</script>
	</head>
	<body>
		<script>
			var colorset = [["#22BBFF","#66BB00","#FF7700","#FF55CC","#7766FF","#EE2244","#DDCC22"],["#66CCFF","#339966","#FF9900","#FF99AA","#0044FF","#FF2200","#FFFF00"]];
			var set = 0;
			function changecolor(sender){
				if (!Number.isInteger(+sender.value)){sender.style.backgroundColor = "white"; return;}
				if (+sender.value < 0 || +sender.value > 6){sender.style.backgroundColor = "white"; return;}
				sender.style.backgroundColor = colorset[0][+sender.value];
			}
		</script>
		<img class="bg" src="../img/background_stage.png"></div>
		<canvas class="bg" width="1174" height="660"></canvas>
		<img id="flashlight" class="bg hidden" src="mod/flashlight.png"></canvas>
		<img id="hidden" class="bg hidden" src="mod/hidden.png"></canvas>
		<div id="youtube" style="display:none"></div>
		<video style="display:none" class="r16_9" src="" frameborder="0" playsinline></video>
		<img id="pause" src="../img/button_menu.png" onclick="pause()">
		<div class="protect fullscreen">
		</div>
		<div id="startscreen" class="start fullscreen" onclick="start(this)" style="display:none">
		Start
			<div class="options" onclick="event.stopPropagation();">
				Color Options:<br>
				<img id="color1" onclick="set=0;this.setAttribute('class','selected');document.getElementById('color2').setAttribute('class','unselected')" class="selected" src="../img/note/image_notes_1.png"><br>
				<img id="color2" onclick="set=1;this.setAttribute('class','selected');document.getElementById('color1').setAttribute('class','unselected')" class="unselected" src="../img/note/image_notes_2.png">
			</div>
			<div class="modselect" onclick="event.stopPropagation();">
				Color Options:<br>
				<img id="m1" onclick="this.setAttribute('class',(this.getAttribute('class')=='selected'?'unselected':'selected')); mod^=1" class="unselected" src="mod/icon_grayscale.png"><!--
				--><img id="m2" onclick="this.setAttribute('class',(this.getAttribute('class')=='selected'?'unselected':'selected')); mod^=2" class="unselected" src="mod/icon_flashlight.png"><!--
				--><img id="m4" onclick="this.setAttribute('class',(this.getAttribute('class')=='selected'?'unselected':'selected')); mod^=4" class="unselected" src="mod/icon_hidden.png">
			</div>
		</div>
		<div id="pausescreen" class="pause fullscreen" onclick="resume(this)" style="display:none">
		Resume
		</div>
		<div id="endscreen" class="vend fullscreen" style="display:none">
			Ended<br><br>
			Playdata:<br>
			<textarea id="playdata" rows="4" cols="50" readonly></textarea><br>
			<button onclick="copy()">Copy</button><br><br>
			<button onclick="replay(playdatabase + playdata)">Replay</button><br><br>
			<button onclick="restart()">Restart</button>
		</div>
		<div id="emptyscreen" class="empty fullscreen" style="display:none">
			<br>
			<div style="border: 1px solid black; background-color: white; color: black;">
				<h3>Link creator:</h3>
				Source: <input type="radio" name="src" id="Youtube">Youtube <input type="radio" name="src" id="Video" checked>Video<br>
				Aspect Ratio: <input type="radio" name="aspect" id="r16_9" checked>16:9 <input type="radio" name="aspect" id="r4_3">4:3<br>
				URL: <input type="text" id="url" value=""><br>
				Color: 
				<input type="text" id="b1" value="0" onchange="changecolor(this)"><!--
				--><input type="text" id="b2" value="0" onchange="changecolor(this)"><!--
				--><input type="text" id="b3" value="0" onchange="changecolor(this)"><!--
				--><input type="text" id="b4" value="0" onchange="changecolor(this)"><!--
				--><input type="text" id="b5" value="0" onchange="changecolor(this)"><!--
				--><input type="text" id="b6" value="0" onchange="changecolor(this)"><!--
				--><input type="text" id="b7" value="0" onchange="changecolor(this)"><br>
				<button onclick="createlink()">Create a link</button><br>
				(Color Reference: <div id="r1">0</div><div id="r2">1</div><div id="r3">2</div><div id="r4">3</div><div id="r5">4</div><div id="r6">5</div><div id="r7">6</div>)
			</div>
			<br>
			<div style="border: 1px solid black; background-color: white; color: black;">
				<h3>Replay:</h3>
				<textarea id="replaydata" rows="4" cols="50"></textarea><br>
				<button onclick="replay(atob(document.getElementById('replaydata').value))">Input Playdata</button>
			</div>
		</div>
		
		<script>
			function id(id){
				return document.getElementById(id);
			}
			function createlink(){
				var loc = location.href;
				var dir = loc.substring(0, loc.lastIndexOf('/'));
				var parameter = [];
				var url = id("url").value;
				if (id("Youtube").checked){
					if (url.length != 11){
						url = url.match(/(?:watch\?v=|embed\/|v\/|youtu.be\/)([^]{11})/)[1];
					}
					parameter.push("youtube=" + url);
				} else if (id("Video").checked){
					parameter.push("video=" + btoa(url).replace(/=/g,"-").replace(/\//g,"."));
				} else {
					alert("No source chosen!!");
					return;
				}
				if (id("r16_9").checked){
					parameter.push("aspect=16_9");
				} else if (id("r4_3").checked){
					parameter.push("aspect=4_3");
				} else {
					parameter.push("aspect=16_9");
				};
				var dirt = "";
				for (var temp = 0; temp < 7; temp++){
					var tempv = +id('b' + (temp + 1)).value;
					if (!Number.isInteger(tempv)){alert("Invalid Value: " + tempv); return;}
					if (tempv < 0 || tempv > 6){alert("Invalid Value: " + tempv); return;}
					dirt += tempv;
				}
				parameter.push("position=" + dirt);
				var url = dir + "/live.html?" + parameter.join("&");
				prompt("Here is the link:", url);
			}
			for (var temp = 0; temp < 7; temp++){
				document.getElementById('r' + (temp + 1)).style.backgroundColor = colorset[0][temp];
				document.getElementById('b' + (temp + 1)).style.backgroundColor = colorset[0][0];
			}
			
			var iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
			var mode = "";
			var target = undefined;
			var position = [0,0,0,0,0,0,0];
			var playdatabase0 = "";
			var playdatabase = "";
			var playdata = "";
			var offset = 0;
			var mod = 0;
			/*
			mod1: grayscale
			mod2: flashlight
			mod4: hidden
			*/
			var replaydata = [];
			var replays = false;
			
			//handle link
			var youtubeready = false;
			var waityoutube = -1;
			function onYouTubeIframeAPIReady() {
				youtubeready = true;
				if (waityoutube != -1){
					waityoutube();
				};
			}
			
			function other(target){
				if (!replays && items["aspect"]){
					playdatabase0 += "aspect=" + items["aspect"] + ";";
				}
				items["aspect"] = (items["aspect"]?items["aspect"]:"16_9");
				target.setAttribute("class", "r" + items["aspect"]);
				target.style.display = "block";
			}
			
			function processlink(){
				var queryString = window.location.search.slice(1).split('&');
				items = [];
				for (var i = 0; i < queryString.length; i++) {
					parts = queryString[i].split('=');
					items[parts[0]] = parts[1];
				}
				if (items["position"] != undefined){
					position = items["position"].split("");
					playdatabase0 += "position=" + items["position"] + ";";
				}
				if (items["youtube"] != undefined){
					mode = "youtube";
					playdatabase0 += "youtube=" + items["youtube"] + ";";
					/*var ytid = items["youtube"];
					target = document.getElementsByTagName("iframe")[0];
					target.setAttribute("src","https://www.youtube.com/embed/" + ytid + "?playsinline=1&rel=0&modestbranding=1&autohide=1&showinfo=0&controls=0")
					target.style.display = "block";*/
					var callback =  function(){
						target = new YT.Player('youtube', {
							videoId: items["youtube"],
							playerVars: {'controls': 0, 'playsinline': 1, 'showinfo': 0, 'modestbranding': 1, 'rel': 0},
							events: {
								onReady: function(){document.getElementById("startscreen").style.display = "block"},
								onStateChange: onPlayerStateChange
							}
						});
						other(document.getElementsByTagName("iframe")[0]);						
					};
					if (youtubeready){
						callback();
					} else {
						waityoutube = callback;
					}
				/*} else if (items["iframe"] != undefined){
					mode = "iframe";
					target.setAttribute("src", atob(items["iframe"].replace(/-/g,"=").replace(/\./g,"/")));*/
				} else if (items["video"] != undefined){
					mode = "video";
					playdatabase0 += "video=" + items["video"] + ";";
					var url = atob(items["video"].replace(/-/g,"=").replace(/\./g,"/"));
					target = document.getElementsByTagName("video")[0];
					target.setAttribute("src", url)
					other(target);
					target.onended = function() {      
						videoend();
					};
					document.getElementById("startscreen").style.display = "block";
				} else { //empty mode
					mode = "empty";
					document.getElementById("emptyscreen").style.display = "block";
				}
			}
			processlink();
			
			function onPlayerStateChange(event) {        
				if(event.data === 0) {          
					videoend();
				}
			}
			
			//handle start/stop
			
			function start(sender){
				color = position.join(",").split(",");
				if (replays){					
					replaytimer = setInterval(replaycheck,0);
					replaytemp = 0;
				} else {
					playdatabase = playdatabase0;
					playdata = "mod=" + mod + ";";
					playdata += "offset=0;";
					playdata += "start;";
				}
				if (mod & 1){ //grayscale
					document.body.setAttribute("class", "grayscale");
				} else {
					document.body.removeAttribute("class");
				}
				if (mod & 2){ //flashlight
					id("flashlight").setAttribute("class", "bg");
				} else {
					id("flashlight").setAttribute("class", "bg hidden");
				}
				if (mod & 4){ //hidden
					id("hidden").setAttribute("class", "bg");
				} else {
					id("hidden").setAttribute("class", "bg hidden");
				}
				if (!iOS){
					document.body.requestFullscreen();
				}
				if (mode == "youtube") {
					target.playVideo();
				} else if (mode == "video") {
					target.play();
				}
				if (sender){
					sender.style.display = "none";
				}
			}
			
			function pause(){
				if (mode == "youtube") {
					target.pauseVideo();
				} else if (mode == "video") {
					target.pause();
				}
				document.getElementById("pausescreen").style.display = "block";
			}
			
			function resume(sender){
				if (mode == "youtube") {
					target.playVideo();
				} else if (mode == "video") {
					target.play();
				}
				if (sender){
					sender.style.display = "none";
				}
			}
			
			function restart(){
				color = position.join(",").split(",");
				replays = false;
				playdatabase = playdatabase0;
				if (mode == "youtube") {
					target.playVideo();
				} else if (mode == "video") {
					target.play();
				}
				document.getElementById("endscreen").style.display = "none";
			}
			
			function replay(content){
				//split by ;
				replays = true;
				playdatabase = "";
				playdata = content;
				var para = content.split(";");
				var i = 0;
				items["aspect"] = "16_9";
				position = "0000000".split("");
				while (i < para.length && para[i] != "start"){
					var para2 = para[i].split("=");
					if (!para2.length) return;
					switch (para2[0]){
						case "youtube":
							mode = "youtube";
							items["youtube"] = para2[1];
							id("youtube").outerHTML = '<div id="youtube" style="display:none"></div>';
							var callback =  function(){
								target = new YT.Player('youtube', {
									videoId: items["youtube"],
									playerVars: {'controls': 0, 'playsinline': 1, 'showinfo': 0, 'modestbranding': 1, 'rel': 0},
									events: {
										onReady: function(){document.getElementById("startscreen").style.display = "block"},
										onStateChange: onPlayerStateChange
									}
								});
								other(document.getElementsByTagName("iframe")[0]);						
							};
							if (youtubeready){
								callback();
							} else {
								waityoutube = callback;
							}
							break;
						case "video":
							mode = "video";
							var url = atob(para2[1].replace(/-/g,"=").replace(/\./g,"/"));
							target = document.getElementsByTagName("video")[0];
							target.setAttribute("src", url)
							if (!target.onended){
								target.onended = function() {      
									videoend();
								};
							};
							if (items["aspect"]){
								target.setAttribute("class", "r" + items["aspect"]);
							};
							document.getElementById("startscreen").style.display = "block";
							target.style.display = "block";
							break;
						case "position":
							position = para2[1].split("");
							color = position.join(",").split(",");
							break;
						case "aspect":
							items["aspect"] = para2[1];
							if (target) {
								if (mode == "youtube") {
									document.getElementsByTagName("iframe")[0].setAttribute("class", "r" + items["aspect"]);
								} else if (mode == "video") {
									target.setAttribute("class", "r" + items["aspect"]);
								}
							};
							break;
						case "mod":
							mod = +para2[1];
							for (var m = 1; m <= 4; m*=2){
								id("m" + m).setAttribute('class',(mod & m)?'selected':'unselected');
							};
							break;
						case "offset":
							offset = +para2[1];
							break;
					}
					i++;
				}
				i++; //skip start
				replaydata = [];
				var c = 0;
				while (i < para.length){
					if (para[i].trim() != ""){
						replaydata[c] = para[i].split(",");
						c++;
					}
					i++;
				}
				document.getElementById("endscreen").style.display = "none";
				document.getElementById("emptyscreen").style.display = "none";
			}
			
			function replaycheck(){
				var t = getTime();
				while (replaytemp < replaydata.length && replaydata[replaytemp][0] <= +t + offset){
					switch (replaydata[replaytemp][1]){
						case "d":
							mstart(+replaydata[replaytemp][2], +replaydata[replaytemp][3], +replaydata[replaytemp][4]);
							break;
						case "m":
							move(+replaydata[replaytemp][2], +replaydata[replaytemp][3], +replaydata[replaytemp][4]);
							break;
						case "u":
							mend(+replaydata[replaytemp][2], +replaydata[replaytemp][3], +replaydata[replaytemp][4]);
							break;
					}
					replaytemp++;
				};
			}
			
			function getTime(){
				if (mode == "youtube") {
					return target.getCurrentTime().toFixed(3);
				} else if (mode == "video") {
					return target.currentTime.toFixed(3);
				}
			}
			
			function videoend() {
				if (replays) {
					clearInterval(replaytimer);
				};
				document.getElementById('playdata').value = btoa(playdatabase + playdata);
				document.getElementById("endscreen").style.display = "block";
			}
			
			function copy() {
				if (!iOS){
					document.getElementById('playdata').select();
					document.execCommand('copy');
				} else {
					document.getElementById('playdata').focus();
					document.getElementById('playdata').setSelectionRange(0, document.getElementById('playdata').value.length);
					document.execCommand('copy');
					document.getElementById('playdata').setSelectionRange(0, 0);
				};
				alert('Copied to clipboard');
			}
			
			//handle touches
			//var iOSfirst = 0;
			var iOStouch = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]; //11 touches maximum for iOS
			function addidentifier(ide){
				if (!iOS) return;
				//find a -1
				var i = 0;
				while (i < 11){
					if (iOStouch[i] == -1){
						iOStouch[i] = ide;
						return;
					}
					i++;
				}
			}
			function getidentifier(ide){
				if (!iOS) return ide;
				var i = 0;
				while (i < 11){
					if (iOStouch[i] == ide){
						return i;
					}
					i++;
				}
			}
			function delidentifier(ide){
				if (!iOS) return;
				var i = 0;
				while (i < 11){
					if (iOStouch[i] == ide){
						iOStouch[i] = -1;
						return;
					}
					i++;
				}
			}
			
			var canvas = document.getElementsByTagName("canvas")[0];
			ctx = canvas.getContext("2d");
			function canvascoord(x,y){
				var rect = canvas.getBoundingClientRect();
				var canwidth = canvas.getAttribute("width");
				var canheight = canvas.getAttribute("height");
				return [canwidth * (x - rect.left) / rect.width, canheight * (y - rect.top) / rect.height];
			};
			
			dragged = [-1, -1, -1, -1, -1, -1, -1];
			vectort = [0, 0, 0, 0, 0, 0, 0];
			vectorv = [0, 0, 0, 0, 0, 0, 0];
			color = position.join(",").split(",");
			
			//touches = [];
			dragging = [];
			
			function mstart(identifier, x, y, time = -1){
				if (!replays){
					playdata += (time==-1?getTime():time) + ",d," + identifier + "," + x.toFixed(1) + "," + y.toFixed(1) + ";";
				};
				dragging[identifier] = [];
				dragging[identifier].valid = false;
				//if (realcoord[1] >= 472 && realcoord[1] <= 532){ //y passed
					if (((x+32-377) % 70) < 64){ //x passed
						var num = Math.floor((x+32-377) / 70);
						//var sq = function(a){return a*a};
						/*if (num >= 0 && num <= 6 && sq(377 + 70 * num - realcoord[0]) + sq(realcoord[1]-502) <= sq(32)){ //r passed*/
						if (num >= 0 && num <= 6 && ((y >= 346) || (num == 0) || (num == 6))){ //tolerant one like in game
							if (dragged[num] == -1){ //if stay here
								dragging[identifier].num = num;
								dragging[identifier].x = 377 + 70 * num;
								dragging[identifier].y = 502;
								dragging[identifier].ox = x - (377 + 70 * num);
								dragging[identifier].oy = y - 502;
								dragging[identifier].valid = true;
								dragged[num] = identifier;
							}
						}
					}
				//}
			}
			
			canvas.addEventListener("touchstart", function (e) {
				event.preventDefault();
				if (replays){return};
				//touches = e.touches;
				var temp = e.changedTouches;
				for (var i = 0; i < temp.length; i++){
					//convert to canvas coord	
					addidentifier(temp[i].identifier);
					var identifier = getidentifier(temp[i].identifier);
					var realcoord = canvascoord(temp[i].clientX, temp[i].clientY);
					mstart(identifier, realcoord[0], realcoord[1]);					
				}
			});
			
			function move(identifier, x, y, time = -1){
				if (!replays){
					playdata += (time==-1?getTime():time) + ",m," + identifier + "," + x.toFixed(1) + "," + y.toFixed(1) + ";";
				};
				if (dragging[identifier].valid){
					dragging[identifier].x = x - dragging[identifier].ox;
					dragging[identifier].y = y - dragging[identifier].oy;
					realcoord = [dragging[identifier].x, dragging[identifier].y];
					//check swap
					if (realcoord[1] >= 472 && realcoord[1] <= 532){ //y passed
						if (((realcoord[0]+32-377) % 70) < 64){ //x passed
							var num = Math.floor((realcoord[0]+32-377) / 70);
							if (num >= 0 && num <= 6 && num != dragging[identifier].num){ //only handle changed position
								//console.log(num + " " + dragging[identifier].num);
								var sq = function(a){return a*a};
								if (sq(377 + 70 * num - realcoord[0]) + sq(realcoord[1]-502) <= sq(32)){ //r passed
									//swap
									//swap color
									var tempswap = color[num];
									color[num] = color[dragging[identifier].num];
									color[dragging[identifier].num] = tempswap;
									//swap representative
									//swap the opponent's dragging information
									if (dragged[num] == -1){ //if it is not picked up
										vectort[dragging[identifier].num] = new Date().getTime();
										vectorv[dragging[identifier].num] += (num - dragging[identifier].num) * 70;
										dragged[dragging[identifier].num] = -1;
										dragged[num] = identifier;
									} else {
										dragging[dragged[num]].num = dragging[identifier].num;
										dragged[dragging[identifier].num] = dragged[num];
										dragged[num] = identifier;
									}
									//assign new number
									dragging[identifier].num = num;
								}
							}
						}
					}
				}
			};
			
			canvas.addEventListener("touchmove", function (e) {
				event.preventDefault();
				if (replays){return};
				//touches = e.touches;
				var temp = e.changedTouches;
				for (var i = 0; i < temp.length; i++){
					var identifier = getidentifier(temp[i].identifier);
					var realcoord = canvascoord(temp[i].clientX, temp[i].clientY);
					move(identifier, realcoord[0], realcoord[1]);
				}
			});
			
			function mend(identifier, x, y, time = -1){
				if (!replays){
					playdata += (time==-1?getTime():time) + ",u," + identifier + "," + x.toFixed(1) + "," + y.toFixed(1) + ";";
				};
				if (dragging[identifier].valid){
					dragging[identifier].valid = false;
					dragged[dragging[identifier].num] = -1;
					vectort[dragging[identifier].num] = new Date().getTime();
					vectorv[dragging[identifier].num] = x - dragging[identifier].ox - (377 + 70 * dragging[identifier].num);
				}
			}
			
			canvas.addEventListener("touchend", function (e) {
				event.preventDefault();
				if (replays){return};
				//touches = e.touches;
				var temp = e.changedTouches;
				for (var i = 0; i < temp.length; i++){
					var identifier = getidentifier(temp[i].identifier);
					var realcoord = canvascoord(temp[i].clientX, temp[i].clientY);
					mend(identifier, realcoord[0], realcoord[1]);
					delidentifier(temp[i].identifier);
				}
			});
			
			finishframe = true;
			function nextframe(){
				//reset screen
				ctx.clearRect(0, 0, canvas.getAttribute("width"), canvas.getAttribute("height"));
				
				//draw touches
				for (var i = 0; i < 7; i++) {
					if (dragged[i] == -1){ //draw in original position
						ctx.beginPath();
						if (vectorv[i] != 0){
							var change = new Date().getTime() - vectort[i];
							if (Math.abs(vectorv[i]) < change){
								vectorv[i] = 0;
							} else if (vectorv[i] > 0) {
								vectorv[i] -= change;
							} else {
								vectorv[i] += change;
							}
							vectort[i] += change;
							ctx.arc(377 + 70 * i + vectorv[i], 502, 32, 0, 2 * Math.PI);
						} else {
							ctx.arc(377 + 70 * i, 502, 32, 0, 2 * Math.PI);
						};
						ctx.fillStyle = colorset[set][color[i]];
						ctx.fill();
					};
				}
				
				//moving one always on top
				for (var i = 0; i < 7; i++) {
					if (dragged[i] > -1){
						ctx.beginPath();
						ctx.arc(dragging[dragged[i]].x, dragging[dragged[i]].y, 36, 0, 2 * Math.PI);
						ctx.fillStyle = "white";
						ctx.fill();
						ctx.beginPath();
						ctx.arc(dragging[dragged[i]].x, dragging[dragged[i]].y, 32, 0, 2 * Math.PI);
						ctx.fillStyle = colorset[set][color[i]];
						ctx.fill();
					};
				}				
				finishframe = true;
			};
			timer = setInterval(function(){if(finishframe){finishframe = false;nextframe();}},1);
			
			//cheat mode
			var toggle = true;
			document.addEventListener('keydown', function(event) {
				if(event.keyCode == 32) {
					toggle = !toggle;
					if (toggle) { 
						resume(id("pausescreen"));
					} else {
						pause();
					};
				}
				if(event.keyCode == 37) {
					if (mode == "youtube") {
						target.seekTo(getTime() - 0.1);
					} else if (mode == "video") {
						target.currentTime() -= 0.1;
					}
				}
				if(event.keyCode == 39) {
					if (mode == "youtube") {
						target.seekTo(getTime() + 0.1);
					} else if (mode == "video") {
						target.currentTime() += 0.1;
					}
				}
			});
			var idss = 0;
			var basetime = -1;
			function swap(from, to, cont = false){
				if (!cont){
					basetime = getTime();
				};
				mstart(idss, 377 + 70 * from, 502, basetime);
				var sq = function(a){return a*a};
				var m = 156 / sq(70 * (from - to) / 2);
				for (var i = from + (to>from?0.141:-0.141); (i - to) * (to>from?1:-1) < 0; i += (to>from?0.141:-0.141)){
					move(idss, 377 + 70 * i, m * sq(70 * ((from + to) / 2 - i)) + 346, basetime+Math.abs(i-from)*0.1);
				}
				mend(idss, 377 + 70 * to, 502, basetime+Math.abs(to-from)*0.1);
				basetime = getTime()+Math.abs(to-from)*0.1;
				idss = (idss+1)%10;
			};
			function tap(loc){
				resume(id("pausescreen"));
				mstart(idss, 377 + 70 * loc, 502);
				mend(idss, 377 + 70 * loc, 502, getTime()+0.1);
				idss = (idss+1)%10;
				pause();
			};
		</script>
	</body>
</html>